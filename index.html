<!doctype html>
<html><head><title>Super Outliner</title>
<!-- <link rel="stylesheet" href="common.css"> -->
<style type="text/css">
.outlines {position:relative;}
.prototype {display:none;}
.item {margin:1ex;}
.title {font-weight:bold; height:1em;}
.note { height:1em; font-size:.8em; border-top:0;}
textarea {line-height:1em; border:1px solid #ccc; display:block; width:100%;
  font-family:inherit; font-size:inherit; margin:0; max-width:500pt;}
li {display:block;}

.controls {-webkit-column-width:15em;}
</style>

<script src="jquery-1.3.2.js"></script>
<script src="jquery.autogrow.js"></script>
<script type="text/javascript">
var keys = {enter:13, tab:9, up:38, down:40, del:8}
$(document).ready(function(){
       
  function create_item(insert){
    var node = $('.item.prototype').clone().removeClass('prototype')
    insert(node)
    node.find('.note').keydown(note_keydown).autogrow({extraSpace:100})
    node.find('.title').keydown(title_keydown).focus()    
  }

  function indent(item){
    var prev = item.prev()
    if (prev.length){
      item.appendTo(prev.find('.contents:first'))
      focus_item(item)
    }
  }
  
  function dedent(item){
    var parent = item.parents('.item:first')
    if (parent.length){
      parent.after(item)
      focus_item(item)
    }
  }

  function focus_item(item){
    return item.find('.title:first').focus()
  }

  function focus_prev(item){
    var prev = item.prev('.item:first') // find prev sibling
     if (prev.length) {
       var child = prev.find('.item:last') // prefer sibling's last x-child
       if (child.length) prev = child
     } else {
       prev = item.parents('.item:first') // settle for own parent
     }
     return focus_item(prev)
  }  
  
  function focus_next(item){
    var next = item.find('.item:first') // prefer first child
    if (!next.length) next = item.next() // settle for next sibling
    if (!next.length) { // settle for x-parent's next sibling
      next = item
      while (true){
        next = next.parents('.item:first')
        if (!next.length) break // no solution
        var neighbor = next.next()
        if (neighbor.length){
          next = neighbor // found it
          break
        }
      }
    }
    return focus_item(next)    
  }
    
  function move_up(item){
    item.prev().before(item)
    focus_item(item)
  }

  function move_down(item){
    item.next().after(item)
    focus_item(item)
  }
  
  function delete_item(item){
    event.preventDefault()
    if (focus_prev(item).length || focus_next(item).length){
      item.remove()
    } else {
      item.find('.title, .note').val('') // can't delete last node
    }
  }

  function note_keydown(event){
    if(event.which == keys.enter && event.shiftKey){
      var item = $(this).parents('.item:first')
      item.find('.title').focus()
    }
  }

  function title_keydown(event){
    var item = $(this).parents('.item:first')

    // console.debug(event.which)
    if(event.which == keys.enter){
      event.preventDefault()
      if (!event.shiftKey)      create_item(function(node){ item.after(node) })
      else                      item.find('.note').focus()

    } else if (event.which == keys.tab){
      event.preventDefault()
      if (!event.shiftKey)      indent(item)
      else                      dedent(item)

    } else if (event.which == keys.up){
      if (event.shiftKey)       move_up(item)
      else if (event.altKey)    focus_item(item.prev())
      else                      focus_prev(item)

    } else if (event.which == keys.down){
        if (event.shiftKey)     move_down(item)
        else if (event.altKey)  focus_item(item.next())
        else                    focus_next(item)
    } 

    else if (event.which == keys.del && ($(this).val() == "" || event.ctrlKey)) {
      event.preventDefault()
      delete_item(item)
    }
  }



  create_item(function(node){ node.prependTo('.outlines') })
  // hmm, what about deleting items?  
})
</script>


</head><body>
  <ul class="controls">
    <li>Enter: New Sibling.
    <li>Shift+Enter: Edit Note/Title Part.
    <li>Tab: Indent.
    <li>Shift+Tab: Dedent.
    <li>Up/Down: Navigate Tree.
    <li>Shift+Up/Down: Move Sibling.
    <li>Alt+Up/Down: Navigate Siblings.
    <li>Ctrl-Backspace: Delete.
  </ul>
<!-- <div class="notify"></div> -->

<ul class="outlines">
  
</ul>

<li class="item prototype" data-indents="0">
  <textarea class="title"></textarea>
  <textarea class="note"></textarea>
  <ul class="contents"></ul>
</li>

</body></html>