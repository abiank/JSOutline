<!doctype html>
<html><head><title>Super Outliner</title>
<!-- <link rel="stylesheet" href="common.css"> -->
<style type="text/css">
.outlines {position:relative;}
.prototype {display:none !important;}
.item {margin:1ex 0 1ex; display:block;}
.title {font-weight:bold; height:1em;}
.note { height:1em; font-size:.8em; border-top:0;}
textarea {line-height:1em; border:1px solid #ccc; display:block; width:100%;
  font-family:inherit; font-size:inherit; margin:0; max-width:500pt;}


.folded .contents {display:none;}
.folded {border-bottom:1px dashed gray; padding-bottom:2px; }
.controls {-webkit-column-width:15em; -moz-column-width:15em;}

.title {-webkit-border-radius:4pt 4pt 0 0; -moz-border-radius:4pt 4pt 0 0;}
.note  {-webkit-border-radius:0 0 4pt 4pt; -moz-border-radius:0 0 4pt 4pt;}
.title, .note {padding:2pt;}
.title {padding-bottom:0;}
.note {padding-top:0;}
</style>

<script src="jquery-1.3.2.js"></script>
<script src="jquery.autogrow.js"></script>
<script type="text/javascript">
var keys = {enter:13, tab:9, up:38, down:40, left:37, right:39, del:8}
$(document).ready(function(){
       
  function create_item(insert){
    var node = $('.item.prototype').clone().removeClass('prototype')
    insert(node)
    node.find('.note').keydown(note_keydown).autogrow({extraSpace:100})
    node.find('.title').keydown(title_keydown).focus()    
  }

  function indent(item){
    var prev = item.prev()
    if (prev.length && !prev.hasClass('folded')){
      item.appendTo(prev.find('.contents:first'))
      focus_item(item)
    }
  }
  
  function dedent(item){
    var parent = item.parents('.item:first')
    if (parent.length){
      parent.after(item)
      focus_item(item)
    }
  }

  function focus_item(item){
    return item.find('.title:first').focus()
  }

  function focus_prev(item){
    var prev = item.prev('.item:first') // find prev sibling
    if (prev.length) {
      while (true){
        if (prev.hasClass('folded')) break
        var child = prev.find('.contents:first > .item:last')
        if (!child.length) break // give up
        prev = child
      }
      // // oh crap, still folding issues here.
      // var child = prev.find('.item:last') // prefer sibling's last x-child
      // if (child.length && !prev.hasClass('folded')) prev = child
    }
    if (!prev.length){
      prev = item.parents('.item:first') // settle for own parent
    }
    return focus_item(prev)
  }
  
  function focus_next(item){
    var next
    if (!item.hasClass('.folded')) next = item.find('.item:first') // prefer first child
    if (!next || !next.length) next = item.next() // settle for next sibling
    if (!next.length) { // settle for x-parent's next sibling
      next = item
      while (true){
        next = next.parents('.item:first')
        if (!next.length) break // no solution
        var neighbor = next.next()
        if (neighbor.length){
          next = neighbor // found it
          break
        }
      }
    }
    return focus_item(next)    
  }
    
  function move_up(item){
    var prev = item.prev()
    if (prev.length) prev.before(item)
    // else { // re-parent?  Is this useful?
    //   
    // }
    focus_item(item)
  }

  function move_down(item){
    item.next().after(item)
    focus_item(item)
  }
  
  function delete_item(item){
    event.preventDefault()
    if (focus_prev(item).length || focus_item(item.next()).length){
      item.remove()
    } else {  // can't delete last node
      item.find('.title, .note').val('')
      item.find('.item').remove()
      item.removeClass('folded')
      // should reall get rid of this special case and just do a re-create node if necessary...
    }
  }

  function toggle_fold_item(item){
    if (item.hasClass('folded')) item.removeClass('folded')
    else item.addClass('folded')
  }


  function note_keydown(event){
    if(event.which == keys.enter && event.shiftKey){
      event.preventDefault()
      var item = $(this).parents('.item:first')
      item.find('.title').focus()
    }
  }

  function title_keydown(event){
    var item = $(this).parents('.item:first')

    // console.debug(event.which)
    if(event.which == keys.enter){
      event.preventDefault()
      if      (event.shiftKey)  item.find('.note').focus()
      else if (event.altKey)    toggle_fold_item(item)
      else                      create_item(function(node){ item.after(node) })

    } else if (event.which == keys.tab){
      event.preventDefault()
      if (!event.shiftKey)      indent(item)
      else                      dedent(item)

    } else if (event.which == keys.up){
      event.preventDefault()
      if      (event.shiftKey)  move_up(item)
      else if (event.altKey)    focus_item(item.prev())
      else                      focus_prev(item)

    } else if (event.which == keys.down){
      event.preventDefault()
      if      (event.shiftKey)  move_down(item)
      else if (event.altKey)    focus_item(item.next())
      else                      focus_next(item)

    } else if (event.which == keys.right && event.shiftKey) {
      event.preventDefault()
      indent(item)

    } else if (event.which == keys.left && event.shiftKey) {
      event.preventDefault()
      dedent(item)
    
    } else if (event.which == keys.del && ($(this).val() == "" || event.ctrlKey)) {
      event.preventDefault()
      delete_item(item)
    }
  }



  create_item(function(node){ node.prependTo('.outlines') })
  // hmm, what about deleting items?  
})
</script>


</head><body>
  <ul class="controls">
    <li>Enter: New Sibling
    <li>Shift+Enter: Edit Note/Title
    <li>Shift+Arrows: Move
    <li>Ctrl+Backspace: Delete
    <li>Up/Down: Navigate Tree
    <li>Alt+Up/Down: Navigate Siblings
    <li>Alt+Enter: Toggle Fold
  </ul>
<!-- <div class="notify"></div> -->

<ul class="outlines">
  
</ul>

<li class="item prototype" data-indents="0">
  <textarea class="title"></textarea>
  <textarea class="note"></textarea>
  <ul class="contents"></ul>
</li>

</body></html>