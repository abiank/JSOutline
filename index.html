<!doctype html>
<html><head><title>Super Outliner</title>
<!-- <link rel="stylesheet" href="common.css"> -->
<style type="text/css">
.prototype {display:none;}
input, textarea {border:1px solid lightgrey; display:block;}
li {display:block;}
</style>

<script src="jquery-1.3.2.js"></script>
<script type="text/javascript">
var keys = {enter:13, tab:9, up:38, down:40}
$(document).ready(function(){
  
  function note_keydown(event){
    if(event.which == keys.enter && event.shiftKey){
      event.preventDefault()
      var item = $(this).parents('.item:first')
      item.find('.title').focus()
    }
  }
  
  function create_item(insert){
    var node = $('.item.prototype').clone().removeClass('prototype')
    insert(node)
    node.find('.note').keydown(note_keydown)
    node.find('.title').keydown(title_keydown).focus()    
  }
    
  function title_keydown(event){
    var item = $(this).parents('.item:first')

    if(event.which == keys.enter){
      event.preventDefault()
      if (!event.shiftKey) { // NEW
        create_item(function(node){ item.after(node) })
      } else {
        item.find('.note').focus()
      }

    } else if (event.which == keys.tab){
      event.preventDefault()
      if (!event.shiftKey){ // INDENT
        var prev = item.prev()
        if (prev.length){
          item.appendTo(prev.find('.contents:first'))
          item.find('input:first').focus()
        }        
      } else { // DEDENT
        var parent = item.parents('.item:first')
        if (parent.length){
          parent.after(item)
          item.find('input:first').focus()
        }
      }      

    // TODO: when I add folding, add ".visible" to these selectors
    } else if (event.which == keys.up){ // PREV
      var prev = item.prev('.item:first') // find prev sibling
      if (prev.length) {
        var child = prev.find('.item:last') // prefer sibling's last x-child
        if (child.length) prev = child
      } else {
        prev = item.parents('.item:first') // settle for own parent
      }
      prev.find('input:first').focus()

    } else if (event.which == keys.down){ // NEXT
      var next = item.find('.item:first') // prefer first child
      if (!next.length) next = item.next() // settle for next sibling
      if (!next.length) { // settle for x-parent's next sibling
        next = item
        while (true){
          next = next.parents('.item:first')
          if (!next.length) break // no solution
          var neighbor = next.next()
          if (neighbor.length){
            next = neighbor // found it
            break
          }
        }
      }
      next.find('input:first').focus()
    }
  }

  create_item(function(node){ node.prependTo('.outlines') })

  
})
</script>


</head><body>
<h1>Outlines</h1>
<!-- <div class="notify"></div> -->

<ul class="outlines">
  
</ul>

<li class="item prototype" data-indents="0">
  <input type="text" class="title"/>
  <textarea class="note"></textarea>
  <ul class="contents"></ul>
</li>

</body></html>